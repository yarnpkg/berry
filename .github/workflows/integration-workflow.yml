on:
  push:
    branches:
    - master
  pull_request:

name: 'Integration'
jobs:
  chore:
    name: 'Testing chores'
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@master
    - run: |
        git fetch --no-tags --unshallow origin HEAD master

    - name: 'Use Node.js 10.x'
      uses: actions/setup-node@master
      with:
        node-version: 10.x

    - name: 'Check that the Yarn files don''t change on new installs (fix w/ "yarn install")'
      run: |
        node ./scripts/run-yarn.js --immutable --immutable-cache
      shell: bash
      env:
        YARN_ENABLE_NETWORK: 0

    - name: 'Check that the cache files are consistent with their remote sources'
      run: |
        if [[ $(git diff --name-only "$(git merge-base origin/"$TARGET_BRANCH" HEAD)" HEAD -- .yarn/cache | wc -l) -gt 0 ]]; then
          node ./scripts/run-yarn.js --immutable --immutable-cache --check-cache
        fi
      shell: bash
      if: |
        github.event.pull_request != ''
      env:
        TARGET_BRANCH: ${{github.event.pull_request.base.ref}}

    - name: 'Check that the patch files are consistent with fresh builds'
      run: |
        if [[ $(git diff --name-only "$(git merge-base origin/"$TARGET_BRANCH" HEAD)" HEAD -- packages/plugin-compat/sources/patches | wc -l) -gt 0 ]]; then
          for generator in packages/plugin-compat/extra/*/gen-*-patch.sh; do
            bash $generator;
          done
          [[ $(git diff --name-only packages/plugin-compat/sources/patches | wc -l) -eq 0 ]]
        fi
      shell: bash
      if: |
        github.event.pull_request != ''
      env:
        TARGET_BRANCH: ${{github.event.pull_request.base.ref}}

    - name: 'Check that the PnP hook is consistent with a fresh build (prebuild)'
      run: |
        node ./scripts/run-yarn.js build:pnp:hook

    - name: Upload the standard bundle
      uses: actions/upload-artifact@v2
      with:
        name: hook
        path: packages/yarnpkg-pnp/sources/hook.js

    - name: 'Check that the PnP hook is consistent with a fresh build'
      run: |
        [[ $(git diff --name-only packages/yarnpkg-pnp/sources/hook.js | wc -l) -eq 0 ]]
      shell: bash
      if: |
        github.event.pull_request != ''
      env:
        TARGET_BRANCH: ${{github.event.pull_request.base.ref}}
