---
slug: release/4.0
title: "Release: Yarn 4.0 ü™Ñ‚öóÔ∏è"
authors: [arcanis]
---

import {TerminalRender} from '@yarnpkg/docusaurus/src/components/TerminalRender';

Today is the day! After more than a year of work, our team is excited to finally put a fancy "stable" sticker on the first release from the 4.x release line! To celebrate, let's make together a tour of the major changes; should you look for a more itemized list, take a look at the [changelog](/advanced/changelog#400).

## Breaking Changes

Those couple of items deserve particular attention when upgrading from 3.x projects:

- We now require Node.js 18+.
- New projects created with `yarn init` won't enable [Zero-Install](http://localhost:3000/features/caching#zero-installs) by default anymore.
- New projects created with `yarn init` will use [Corepack](https://nodejs.org/api/corepack.html) rather than `yarnPath`.
- All official plugins (`typescript`, `interactive-tools`, ...) are now included by default.
- The `yarn workspaces foreach` command has a slightly altered syntax.
- The documentation got a major overhaul (as you can see üòÅ).

## Installing Yarn

Ever since the 2.0 our recommendation has been to install Yarn on a per-project basis using the `yarnPath` setting (automatically set either of `yarn init -2` and `yarn set version`).

We still support `yarnPath`, but both of those commands will now use [Corepack](https://nodejs.org/api/corepack.html) by default; Corepack is the standard utility shipped with Node.js that automatically selects the right package manager version to run depending on the project you're working on.

From now on, no need to check-in the Yarn binary anymore: just set the [`packageManager`](https://nodejs.org/api/packages.html#packagemanager) field (ideally via `yarn init -2` or `yarn set version`), and your team is ready to go.

## JavaScript Constraints

Yarn is the only package manager to implement a [constraints engine](http://localhost:3000/features/constraints). If you don't know it, this feature lets you define a set of rules that your project must satisfy. For instance, the Yarn repository enforces that no two workspaces depend on different versions of any given dependencies, unless explicitly allowed.

Our constraints engine used to be powered by Tau-Prolog, a JavaScript [Prolog](https://en.wikipedia.org/wiki/Prolog#Rules_and_facts) implementation. Unlike imperative languages like JavaScript, Prolog uses a different model called logic programming - you define that something exists if a rule is true. It's a very interesting pattern that integrates well with the concept of rule-based linting.

Unfortunately, Prolog proved too complex to use, increasing the learning curve of constraints past the threshold we were comfortable with. As a result, Prolog constraints are deprecated starting from Yarn 4, and are replaced by a shiny new JavaScript-based engine, with optional TypeScript support!

Jump to the [documentation](/features/constraints#putting-it-all-together) for a quick example to get started.

## TypeScript Integration, Interactive Tools, ... 

Various features in Yarn used to be shipped as sideloaded plugins that needed to be managed separately from the main bundle. While this helped us build a plugin ecosystem, it also proved challenging to manage for our users. We implemented some features to make that easier (auto-upgrade plugins when you auto-update Yarn), but in the end the few KiBs gained by not shipping all the features by default isn't worth the confusion and friction.

As a result, while Yarn still supports third-party plugins (and will continue to in the future), all the features and commands we build are now available as part of the main distribution. You can now use `yarn upgrade-interactive` and `yarn stage` without plugins, and if you have TypeScript configured in your project Yarn will now auto-add and remove `@types` packages as you change your project dependencies.

## Improved User Interface

Various pieces of the UI got revamped to better convey information. For example, `yarn install` now tells you the packages you added, and their total weight:

import addNextTerm from './release-4.0--add-next.term.dat';

<TerminalRender content={addNextTerm}/>

Or the `yarn config` command, which sports a new tree display. It now also accepts an arbitrary number of settings as positional arguments, letting you select precisely what you're interested in.

import configTerm from './release-4.0--config.term.dat';

<TerminalRender content={configTerm}/>

## Performances

The 4.0 isn't lagging behind in performance improvements, and shows to be significantly faster at installs than the 3.6. For instance, here's the difference in time to install Gatsby and its ~350MiB dependency tree from a cold cache:

```
hyperfine -L v stable,canary --prepare 'rm -rf ~/.yarn/berry/cache' 'cd $(mktemp -d) && yarn init -2 && yarn set version {v} && yarn && yarn add gatsby --mode=skip-build'
```

```js
Benchmark 1: 3.6.0
  Time (mean ¬± œÉ):     65.599 s ¬±  2.214 s    [User: 82.952 s, System: 8.638 s]
  Range (min ‚Ä¶ max):   62.167 s ‚Ä¶ 68.277 s    10 runs

Benchmark 2: 4.0.0
  // highlight-next-line
  Time (mean ¬± œÉ):     16.724 s ¬±  0.928 s    [User: 14.622 s, System: 5.743 s]
  // highlight-next-line
  Range (min ‚Ä¶ max):   15.318 s ‚Ä¶ 18.110 s    10 runs

Summary
  4.0.0 ran 3.92 ¬± 0.25 times faster than 3.6.0
```

These changes make Yarn [as fast as pnpm in most scenarios](/features/performances), although competition is still fierce üî•

But we're not done, and more improvements will come in the months to come as we evaluate parts of Yarn we can optimize further. We also plan to investigate using native code in parts of our codebase, although we want to be careful about keeping the code maintainable and easy to jump into for the many third-party contributors who send PRs our way.

## Fancy Website

As you probably noticed, our website received a major overhaul! We worked on this new iteration for more than a year now, and we hope it'll help you find clearer information even faster than before, and prevent them from getting outdated.

Some particular improvements:

- All referenced commands now link to their documentation (`yarn install`)
- All referenced options now have a tooltip explaining their goal (`yarn --immutable-cache`)
- Most pages were rewritten to be both simplified & clarified when needed
- All packages now show a summary of various checks that can be con

Of course, our expertise lies more in tooling that websites, so various hanging fruits remain. If you're interested to help us, check the [sources](https://github.com/yarnpkg/berry/tree/master/packages/docusaurus) and please feel free to send PRs our way!
